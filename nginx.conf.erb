
set $maintenance_mode <%= ENV['MAINTENANCE'] %>;
resolver 1.1.1.1;

# static assets. Fetch the asset on gituhb
location ~* ".*\.\w{1,5}$" {
    if ($maintenance_mode = enabled) {
        return 503;
    }
    proxy_pass https://1024pix.github.io/pix/live/<%= ENV['ENVIRONMENT'] %>$uri;
    proxy_redirect https://1024pix.github.io/pix/live/<%= ENV['ENVIRONMENT'] %> https://<%= ENV['FQDN'] %>;
}

# API
location /api {
    if ($maintenance_mode = enabled) {
        return 503;
    }
    proxy_pass https://<%= ENV['API'] %>;
    proxy_redirect https://<%= ENV['API'] %>/ https://<%= ENV['FQDN'] %>/;
}

# dynamic pages rendered client-side. Always fetch index.html on github
location / {
    if ($maintenance_mode = enabled) {
        return 503;
    }
    rewrite ^.*$ /pix/live/<%= ENV['ENVIRONMENT'] %>/ break;
    proxy_pass https://1024pix.github.io/pix/live/<%= ENV['ENVIRONMENT'] %>/;
    proxy_redirect https://1024pix.github.io/pix/live/<%= ENV['ENVIRONMENT'] %> https://<%= ENV['FQDN'] %>;
}

# Error pages.
error_page 503 /maintenance_page.html;
location = /maintenance_page.html {
    root /app;
}
